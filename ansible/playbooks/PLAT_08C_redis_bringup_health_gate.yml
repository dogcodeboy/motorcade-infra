---
# PLAT_08C â€” Redis bring-up (authoritative, bounded, and stable)
# Goal: make Redis start reliably and prove readiness without any infinite loops.
# Notes:
# - We explicitly DISABLE/MASK the old readiness gate service to prevent hangs.
# - We remove '--log-driver journald' from the redis systemd unit because
#   some Podman/conmon builds lack journald support and will fail with status=126.
#
# Run (from local repo):
#   cd ~/Repos/motorcade-infra/ansible
#   ansible-playbook -i inventories/prod/hosts.ini playbooks/PLAT_08C_redis_bringup_health_gate.yml --ask-vault-pass

- name: PLAT_08C | Redis bring-up + bounded readiness (no infinite gates)
  # Inventory host is named with hyphens (motorcade-web-01). Using the explicit
  # host here avoids host-pattern mismatches.
  hosts: motorcade-web-01
  become: true
  gather_facts: true

  vars:
    podman_bin: /usr/local/bin/podman
    redis_container_name: motorcade-redis
    redis_unit: motorcade-redis.service
    old_ready_unit: motorcade-redis-ready.service
    redis_unit_file: /etc/systemd/system/motorcade-redis.service

    # bounded wait (total ~60s by default)
    redis_wait_retries: 30
    redis_wait_delay: 2

  tasks:
    - name: Preflight | Ensure podman exists at locked path
      ansible.builtin.stat:
        path: "{{ podman_bin }}"
      register: podman_stat

    - name: Preflight | Fail if podman missing
      ansible.builtin.fail:
        msg: "Podman not found at {{ podman_bin }}. Fix PLAT_01B first."
      when: not podman_stat.stat.exists

    - name: Preflight | Check if old readiness gate unit exists
      ansible.builtin.stat:
        path: "/etc/systemd/system/{{ old_ready_unit }}"
      register: ready_unit_stat

    - name: Systemd | Stop old readiness gate (if present)
      ansible.builtin.systemd:
        name: "{{ old_ready_unit }}"
        state: stopped
      when: ready_unit_stat.stat.exists
      ignore_errors: true

    - name: Systemd | Disable + mask old readiness gate (prevents hang loops)
      ansible.builtin.systemd:
        name: "{{ old_ready_unit }}"
        enabled: false
        masked: true
      when: ready_unit_stat.stat.exists
      ignore_errors: true

    - name: Preflight | Ensure redis unit file exists
      ansible.builtin.stat:
        path: "{{ redis_unit_file }}"
      register: redis_unit_stat

    - name: Preflight | Fail if redis unit file missing
      ansible.builtin.fail:
        msg: "Redis unit file missing at {{ redis_unit_file }}. Run PLAT_08B first."
      when: not redis_unit_stat.stat.exists

    - name: Fix | Remove journald log-driver from redis unit (prevents conmon status=126)
      ansible.builtin.replace:
        path: "{{ redis_unit_file }}"
        regexp: '(^\s*ExecStart=.*?)\s+--log-driver\s+journald(\s+|$)'
        replace: '\1\2'
      register: remove_journald

    - name: Systemd | Reload daemon if unit changed
      ansible.builtin.systemd:
        daemon_reload: true
      when: remove_journald is changed

    - name: Systemd | Restart redis service (authoritative bring-up)
      ansible.builtin.systemd:
        name: "{{ redis_unit }}"
        state: restarted
        enabled: true

    - name: Health | Wait for redis to answer PING (bounded)
      ansible.builtin.command: "{{ podman_bin }} exec {{ redis_container_name }} redis-cli ping"
      register: redis_ping
      changed_when: false
      retries: "{{ redis_wait_retries }}"
      delay: "{{ redis_wait_delay }}"
      until: redis_ping.rc == 0

    - name: Verify | Show redis container status
      ansible.builtin.command: "{{ podman_bin }} ps --filter name={{ redis_container_name }} --format '{{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Image{{'}}'}}'"
      register: redis_ps
      changed_when: false

    - name: Verify | Assert container is running
      ansible.builtin.assert:
        that:
          - "'Up' in redis_ps.stdout"
        fail_msg: "Redis container is not Up. Output: {{ redis_ps.stdout }}"
        success_msg: "Redis container is Up and responding."
