---
# PLAT_05 — NGINX Reverse Proxy for LeadGen API (FIX: upstream port align + reliable listen)
- name: PLAT_05 | NGINX reverse proxy for LeadGen API
  hosts: all
  become: true

  vars:
    nginx_conf_path: /etc/nginx/conf.d/motorcade-leadgen-api.conf
    backup_dir: /etc/nginx/backup

    # FIX: Upstream LeadGen API (PLAT_04 root Containerfile) runs on 8000
    leadgen_upstream_host: "127.0.0.1"
    leadgen_upstream_port: "8000"

    # Local proxy listener (internal)
    proxy_listen_port: "8085"

  tasks:
    - name: Check SELinux status
      command: getenforce
      register: selinux_status
      changed_when: false

    - name: Allow nginx to proxy to upstream (SELinux boolean)
      command: setsebool -P httpd_can_network_connect on
      when: selinux_status.stdout != "Disabled"

    - name: Ensure backup directory exists
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "0755"

    - name: Backup existing nginx config if present
      copy:
        src: "{{ nginx_conf_path }}"
        dest: "{{ backup_dir }}/motorcade-leadgen-api.conf.bak"
        remote_src: true
      when: nginx_conf_path is file

    - name: Deploy LeadGen nginx reverse proxy config (server block)
      copy:
        dest: "{{ nginx_conf_path }}"
        mode: "0644"
        content: |
          # Managed by Ansible — PLAT_05
          server {
            # FIX: listen on port (not loopback-only IP) to avoid AL2023 bind quirks.
            listen {{ proxy_listen_port }};
            server_name _;

            location = /lead/health {
              proxy_pass http://{{ leadgen_upstream_host }}:{{ leadgen_upstream_port }}/lead/health;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }

            location = /api/lead/health {
              proxy_pass http://{{ leadgen_upstream_host }}:{{ leadgen_upstream_port }}/lead/health;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }

            location /api/lead/ {
              proxy_pass http://{{ leadgen_upstream_host }}:{{ leadgen_upstream_port }}/;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_connect_timeout 5s;
              proxy_send_timeout 30s;
              proxy_read_timeout 30s;
            }
          }

    - name: Validate nginx configuration
      command: nginx -t

    - name: Reload nginx
      service:
        name: nginx
        state: reloaded
