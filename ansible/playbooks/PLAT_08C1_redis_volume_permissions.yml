---
# PLAT_08C.1 â€” Redis volume permissions invariant (bounded)
# Purpose: Fix Redis crashloop caused by bad volume perms/ownership, then verify Redis is reachable.
# Notes:
# - This playbook NO LONGER relies on any readiness-gate daemon services.
# - Verification is bounded (fail-fast): redis-cli ping with retries.
#
# Run:
#   cd ~/Repos/motorcade-infra/ansible
#   ansible-playbook -i inventories/prod/hosts.ini \
#     playbooks/PLAT_08C1_redis_volume_permissions.yml \
#     --ask-vault-pass

- name: "PLAT_08C.1 | Redis volume permissions invariant (bounded)"
  hosts: motorcade-web-01
  become: true
  gather_facts: true

  vars:
    podman_bin: /usr/local/bin/podman
    redis_container: motorcade-redis
    redis_service: motorcade-redis.service

    redis_volume_dir: /srv/motorcade/volumes/redis

    # Alpine redis image typically uses uid/gid 999
    redis_uid: 999
    redis_gid: 999
    redis_mode: "0700"

    # bounded wait (total ~60s by default)
    redis_wait_retries: 30
    redis_wait_delay: 2

  tasks:
    - name: Preflight | Ensure podman exists at locked path
      ansible.builtin.stat:
        path: "{{ podman_bin }}"
      register: podman_stat

    - name: Preflight | Fail if podman missing
      ansible.builtin.fail:
        msg: "Podman not found at {{ podman_bin }}. Fix PLAT_01B first."
      when: not podman_stat.stat.exists

    - name: Preflight | Verify redis systemd unit exists (PLAT_08B)
      ansible.builtin.stat:
        path: "/etc/systemd/system/{{ redis_service }}"
      register: redis_unit

    - name: Preflight | Fail if redis unit missing
      ansible.builtin.fail:
        msg: "Missing /etc/systemd/system/{{ redis_service }}. Run PLAT_08B first."
      when: not redis_unit.stat.exists

    - name: Filesystem | Ensure redis volume directory exists
      ansible.builtin.file:
        path: "{{ redis_volume_dir }}"
        state: directory
        owner: "{{ redis_uid }}"
        group: "{{ redis_gid }}"
        mode: "{{ redis_mode }}"

    - name: Filesystem | Enforce redis volume ownership + permissions recursively
      ansible.builtin.file:
        path: "{{ redis_volume_dir }}"
        state: directory
        owner: "{{ redis_uid }}"
        group: "{{ redis_gid }}"
        mode: "{{ redis_mode }}"
        recurse: true
      register: perm_fix

    - name: systemd | Restart redis service if permissions changed
      ansible.builtin.systemd:
        name: "{{ redis_service }}"
        state: restarted
        daemon_reload: true
      when: perm_fix.changed

    - name: systemd | Ensure redis service is running
      ansible.builtin.systemd:
        name: "{{ redis_service }}"
        state: started
        enabled: true

    - name: Health | Wait for redis to answer PING (bounded)
      ansible.builtin.command: "{{ podman_bin }} exec {{ redis_container }} redis-cli ping"
      register: redis_ping
      changed_when: false
      retries: "{{ redis_wait_retries }}"
      delay: "{{ redis_wait_delay }}"
      until: redis_ping.rc == 0

    - name: Verify | Show redis container status
      ansible.builtin.command: "{{ podman_bin }} ps --filter name={{ redis_container }} --format '{{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Image{{'}}'}}'"
      register: redis_ps
      changed_when: false

    - name: Verify | Assert container is running
      ansible.builtin.assert:
        that:
          - "'Up' in redis_ps.stdout"
        fail_msg: "Redis container is not Up. Output: {{ redis_ps.stdout }}"
        success_msg: "Redis container is Up and responding."
