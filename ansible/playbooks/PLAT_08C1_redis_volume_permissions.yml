---
# PLAT_08C.1 â€” Redis volume permissions invariant
# Purpose:
# - Fix Redis container start failures caused by non-writable /data volume (exit status 126)
# - Enforce /srv/motorcade/volumes/redis ownership/permissions for Redis image user (uid/gid 999)
# - Ensure readiness gate (motorcade-redis-ready.service) reports Result=success
#
# Notes:
# - Podman is assumed to be manually installed at /usr/local/bin/podman (per platform policy)
# - Verification is done via readiness gate (authoritative), not via systemd "is-active" or racy `podman ps`

- name: "PLAT_08C.1 | Redis volume permissions invariant (fix status=126; readiness gate unblocks)"
  hosts: motorcade_web
  become: true
  gather_facts: true

  vars:
    podman_bin: "/usr/local/bin/podman"
    redis_volume_dir: "/srv/motorcade/volumes/redis"
    redis_uid: "999"
    redis_gid: "999"

  tasks:
    - name: "Preflight | Ensure podman exists at locked path"
      ansible.builtin.stat:
        path: "{{ podman_bin }}"
      register: podman_stat

    - name: "Preflight | Fail if podman missing"
      ansible.builtin.fail:
        msg: "Podman not found at {{ podman_bin }} (platform policy expects manual/static install)."
      when: not podman_stat.stat.exists

    - name: "Preflight | Verify redis unit exists (PLAT_08B)"
      ansible.builtin.stat:
        path: "/etc/systemd/system/motorcade-redis.service"
      register: redis_unit

    - name: "Preflight | Fail if redis unit missing"
      ansible.builtin.fail:
        msg: "motorcade-redis.service not found; PLAT_08B must be applied first."
      when: not redis_unit.stat.exists

    - name: "Preflight | Verify readiness gate unit exists (PLAT_08C)"
      ansible.builtin.stat:
        path: "/etc/systemd/system/motorcade-redis-ready.service"
      register: redis_gate_unit

    - name: "Preflight | Fail if readiness gate unit missing"
      ansible.builtin.fail:
        msg: "motorcade-redis-ready.service not found; PLAT_08C must be applied first."
      when: not redis_gate_unit.stat.exists

    - name: "Preflight | Verify readiness script exists (PLAT_08C)"
      ansible.builtin.stat:
        path: "/usr/local/sbin/motorcade-wait-redis.sh"
      register: redis_wait_script

    - name: "Preflight | Fail if readiness script missing"
      ansible.builtin.fail:
        msg: "motorcade-wait-redis.sh not found; PLAT_08C must be applied first."
      when: not redis_wait_script.stat.exists

    - name: "Filesystem | Ensure redis volume directory exists"
      ansible.builtin.file:
        path: "{{ redis_volume_dir }}"
        state: directory
        mode: "0700"

    - name: "Filesystem | Enforce redis volume owner/group and permissions (uid/gid 999)"
      ansible.builtin.file:
        path: "{{ redis_volume_dir }}"
        owner: "{{ redis_uid }}"
        group: "{{ redis_gid }}"
        mode: "0700"
        recurse: true
      register: redis_vol_perm

    - name: "systemd | Restart redis service if permissions changed"
      ansible.builtin.systemd:
        name: motorcade-redis.service
        state: restarted
        enabled: true
        daemon_reload: true
      when: redis_vol_perm.changed

    # Always (re)run the readiness gate after enforcing invariants; it is authoritative for success.
    - name: "Health gate | Reset failed state (if any)"
      ansible.builtin.command: systemctl reset-failed motorcade-redis-ready.service
      changed_when: false
      failed_when: false

    - name: "Health gate | Run redis readiness gate now"
      ansible.builtin.systemd:
        name: motorcade-redis-ready.service
        state: started
        enabled: true
        daemon_reload: true

    - name: "Verify | Redis readiness gate completed successfully"
      ansible.builtin.command: systemctl show -p Result motorcade-redis-ready.service
      register: redis_ready
      changed_when: false
      failed_when: redis_ready.stdout != "Result=success"
