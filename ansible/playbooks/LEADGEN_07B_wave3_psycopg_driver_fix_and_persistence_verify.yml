---
- name: "LEADGEN_07B â€” Fix persistence adapter (psycopg3 jsonb) + verify lead intake persists to Postgres"
  hosts: motorcade-web-01
  become: true
  gather_facts: true

  vars:
    podman_bin: /usr/local/bin/podman

    # Service area allowlist (Phase 1: config knob; Phase 2: admin console will manage this)
    # Override via inventory/group_vars or -e leadgen_service_area_states='["TX","OK"]'
    leadgen_service_area_states: ["TX"]

    # Authoritative LeadGen working tree on target
    leadgen_repo_dir: /opt/motorcade-leadgen

    # Git ref to deploy (detached).
    # Production stability rule: pin to the last-known-good ref that PASSed LEADGEN_07B.
    # Once the LeadGen fix is merged + tagged, update this to the release tag.
    leadgen_git_ref: "leadgen-wave1-2026-01-28"

    # Runtime
    leadgen_env_path: /etc/motorcade/leadgen.env
    leadgen_systemd_unit: motorcade-leadgen-api.service
    leadgen_expected_image: localhost/motorcade-leadgen-api:wave1

    # Health / Intake
    leadgen_health_url: "http://127.0.0.1:8000/lead/health"
    leadgen_intake_url: "http://127.0.0.1:8000/lead/intake"

  tasks:
    - name: Preflight | podman present (non-standard install path)
      stat:
        path: "{{ podman_bin }}"
      register: podman_stat

    - name: Assert | podman present
      assert:
        that:
          - podman_stat.stat.exists
          - podman_stat.stat.executable

    - name: Assert | LeadGen repo dir exists on target
      stat:
        path: "{{ leadgen_repo_dir }}"
      register: leadgen_repo_stat

    - name: Assert | LeadGen repo dir present
      assert:
        that:
          - leadgen_repo_stat.stat.exists
          - leadgen_repo_stat.stat.isdir

    - name: Git | fetch latest refs (public repo)
      command: git fetch --all --prune
      args:
        chdir: "{{ leadgen_repo_dir }}"
      changed_when: false

    # Auto-clean (authoritative). Deployment workspace must not retain manual edits.
    - name: Git | hard reset + clean (auto-clean; no drift)
      shell: |
        set -euo pipefail
        git reset --hard
        git clean -fd
      args:
        chdir: "{{ leadgen_repo_dir }}"
      changed_when: true

    - name: Git | deploy requested ref (detached)
      command: git checkout --detach "{{ leadgen_git_ref }}"
      args:
        chdir: "{{ leadgen_repo_dir }}"
      changed_when: true

    - name: Git | hard reset to requested ref (no drift)
      command: git reset --hard "{{ leadgen_git_ref }}"
      args:
        chdir: "{{ leadgen_repo_dir }}"
      changed_when: true

    - name: Git | clean untracked after checkout (no drift)
      command: git clean -fd
      args:
        chdir: "{{ leadgen_repo_dir }}"
      changed_when: true

    - name: Git | capture deployed revision (SHA)
      command: git rev-parse HEAD
      args:
        chdir: "{{ leadgen_repo_dir }}"
      register: leadgen_gitsha
      changed_when: false

    - name: Build | capture build time (UTC)
      command: date -u +%Y-%m-%dT%H:%M:%SZ
      register: leadgen_build_time
      changed_when: false

    - name: Stat | app/api/Containerfile (preferred)
      stat:
        path: "{{ leadgen_repo_dir }}/app/api/Containerfile"
      register: cf_app

    - name: Stat | repo-root Containerfile (fallback)
      stat:
        path: "{{ leadgen_repo_dir }}/Containerfile"
      register: cf_root

    - name: Set | containerfile_path + build_context_dir
      set_fact:
        containerfile_path: >-
          {{
            (cf_app.stat.exists | ternary(leadgen_repo_dir ~ '/app/api/Containerfile', ''))
            if (cf_app.stat.exists)
            else (cf_root.stat.exists | ternary(leadgen_repo_dir ~ '/Containerfile', ''))
          }}
        build_context_dir: >-
          {{
            (cf_app.stat.exists | ternary(leadgen_repo_dir ~ '/app/api', leadgen_repo_dir))
          }}

    - name: Assert | containerfile present
      assert:
        that:
          - containerfile_path | length > 0
        fail_msg: "No Containerfile found at {{ leadgen_repo_dir }}/app/api/Containerfile or {{ leadgen_repo_dir }}/Containerfile"

    - name: Build | rebuild LeadGen API image (no-cache)
      command: >
        {{ podman_bin }} build --no-cache
        --build-arg LEADGEN_GIT_SHA={{ leadgen_gitsha.stdout | trim }}
        --build-arg LEADGEN_BUILD_TIME={{ leadgen_build_time.stdout | trim }}
        -f {{ containerfile_path }}
        -t {{ leadgen_expected_image }}
        {{ build_context_dir }}
      changed_when: true

    - name: Restart | LeadGen API service
      systemd:
        name: "{{ leadgen_systemd_unit }}"
        state: restarted
        enabled: true

    - name: Wait | LeadGen API systemd unit active
      command: systemctl is-active "{{ leadgen_systemd_unit }}"
      register: svc_active
      retries: 20
      delay: 1
      until: svc_active.stdout.strip() == "active"
      changed_when: false

    - name: Wait | LeadGen API port 8000 listening
      wait_for:
        host: 127.0.0.1
        port: 8000
        timeout: 30

    - name: Health | GET /lead/health (local)
      uri:
        url: "{{ leadgen_health_url }}"
        method: GET
        return_content: true
        status_code: 200
      register: health_resp

    - name: Show | health (safe)
      debug:
        msg:
          - "health_status={{ health_resp.status }}"
          - "health_body={{ health_resp.content | to_json }}"

    - name: Generate | idempotency key + unique email
      set_fact:
        e2e_idem: "e2e_{{ ansible_date_time.epoch }}"
        e2e_email: "e2e-{{ ansible_date_time.epoch }}@example.com"


    # FIX: payload must satisfy current OpenAPI schema (LeadIntakeRequest: contact+request; request requires service_type+timeline+location)
    - name: Generate | lead intake payload (OpenAPI schema-valid; service-area configurable)
      set_fact:
        lead_payload:
          contact:
            full_name: "E2E Test"
            email: "{{ e2e_email }}"
            phone: "+12125550123"
            preferred_contact_method: "email"
          request:
            service_type: "armed_escort_driver"
            timeline:
              start_local: "2026-02-01 09:00"
              end_local: "2026-02-01 19:00"
            location:
              street: "123 Demo St"
              city: "Houston"
              state: "{{ (leadgen_service_area_states | default(['TX']))[0] }}"
              postal_code: "77002"
            site_type: "commercial"
            notes: "E2E payload - schema-valid"
            recurrence: "one_time"
            expected_hours: 10
          context:
            lead_source: "ansible-e2e"
            referrer_url: "local://ansible"
            utm:
              source: "ansible"
              medium: "e2e"
              campaign: "leadgen_07b"

    - name: Set | intake api key (from env file)
      shell: |
        set -euo pipefail
        set -a
        source "{{ leadgen_env_path }}"
        set +a
        printf "%s" "${LEADGEN_API_KEY:-}"
      register: apikey_out
      changed_when: false

    - name: Assert | intake api key present
      assert:
        that:
          - (apikey_out.stdout | length) > 10

    - name: Intake | POST /lead/intake (capture status/body)
      uri:
        url: "{{ leadgen_intake_url }}"
        method: POST
        headers:
          X-API-Key: "{{ apikey_out.stdout }}"
          Content-Type: "application/json"
          Idempotency-Key: "{{ e2e_idem }}"
        body_format: json
        body: "{{ lead_payload }}"
        return_content: true
        status_code: [200, 201, 202, 409, 422]
      register: intake_resp

    - name: Show | intake result (safe)
      debug:
        msg:
          - "intake_status={{ intake_resp.status }}"
          - "email={{ e2e_email }}"
          - "idempotency_key=<redacted>"
          - "body_snip={{ (intake_resp.content | default(''))[0:220] }}"

    - name: Assert | intake accepted (200/201/202/409)
      assert:
        that:
          - intake_resp.status in [200, 201, 202, 409]
        fail_msg: "Lead intake did not validate/accept. status={{ intake_resp.status }} body_snip={{ (intake_resp.content | default(''))[0:400] }}"

    - name: DB Verify | count rows and show newest
      shell: |
        set -euo pipefail
        {{ podman_bin }} exec -i motorcade-postgres psql -U postgres -d motorcade -c "select count(*) as lead_rows, max(created_at) as newest from app.leads;"
      register: db_check
      changed_when: false

    - name: Show | DB check output
      debug:
        msg: "{{ db_check.stdout_lines }}"
