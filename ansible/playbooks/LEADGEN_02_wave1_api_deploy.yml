---
# LEADGEN_02 — LeadGen Wave 1 API deploy (DB persistence + read-only admin)
#
# Expected:
# - Builds local image: localhost/motorcade-leadgen-api:wave1
# - Runs systemd service: motorcade-leadgen-api.service
# - Binds host: 127.0.0.1:8000 -> container:8080
# - Health: http://127.0.0.1:8000/lead/health
#
# Run:
#   ansible-playbook -i inventories/prod/hosts.ini playbooks/LEADGEN_02_wave1_api_deploy.yml --ask-vault-pass

- name: "LEADGEN_02 — LeadGen Wave 1 API (DB persistence + read-only admin)"
  hosts: motorcade_web
  become: true
  vars:
    podman_bin: "/usr/local/bin/podman"
    leadgen_repo_dir: "/opt/motorcade-leadgen"
    leadgen_image: "localhost/motorcade-leadgen-api:wave1"
    leadgen_container_name: "motorcade-leadgen-api"
    leadgen_env_path: "/etc/motorcade/leadgen.env"
    service_unit_path: "/etc/systemd/system/motorcade-leadgen-api.service"
    host_bind: "127.0.0.1:8000"
    container_port: "8080"
    health_url: "http://127.0.0.1:8000/lead/health"

  tasks:
    - name: "Preflight | podman present"
      ansible.builtin.stat:
        path: "{{ podman_bin }}"
      register: podman_stat
      failed_when: not podman_stat.stat.exists

    - name: "Preflight | motorcade-core network exists"
      ansible.builtin.command: "{{ podman_bin }} network exists motorcade-core"
      changed_when: false

    - name: "Preflight | git present"
      ansible.builtin.command: git --version
      changed_when: false

    - name: "Preflight | require vault keys for Wave 1 auth split"
      ansible.builtin.assert:
        that:
          - vault_leadgen_intake_api_key is defined
          - vault_leadgen_admin_api_key is defined
          - vault_postgres_password is defined
        fail_msg: >-
          Missing required vault values. Ensure these are present in ansible/group_vars/motorcade/vault.yml (encrypted):
          - vault_leadgen_intake_api_key
          - vault_leadgen_admin_api_key
          - vault_postgres_password

    - name: "Filesystem | ensure /opt exists"
      ansible.builtin.file:
        path: "/opt"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: "Repo | clone/update motorcade-leadgen"
      ansible.builtin.git:
        repo: "git@github.com:dogcodeboy/motorcade-leadgen.git"
        dest: "{{ leadgen_repo_dir }}"
        version: "main"
        update: true
        force: false
      register: git_result
      ignore_errors: true

    - name: "Repo | note if git clone is not available (manual fallback)"
      ansible.builtin.debug:
        msg: >-
          NOTE: git clone/update failed (likely missing deploy key on server).
          This playbook expects {{ leadgen_repo_dir }} to exist with the leadgen app source.
          Error: {{ git_result.msg | default('n/a') }}
      when: git_result is failed

    - name: "Config | ensure /etc/motorcade exists"
      ansible.builtin.file:
        path: "/etc/motorcade"
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: "Config | write leadgen env (root-only)"
      ansible.builtin.copy:
        dest: "{{ leadgen_env_path }}"
        owner: root
        group: root
        mode: "0600"
        content: |
          # Motorcade LeadGen Wave 1 API
          LEADGEN_INTAKE_API_KEY={{ vault_leadgen_intake_api_key }}
          LEADGEN_ADMIN_API_KEY={{ vault_leadgen_admin_api_key }}
          POSTGRES_PASSWORD={{ vault_postgres_password }}
          # NOTE: DB integration is Wave 2+; Wave 1 health uses stub/optional checks.

    - name: "Build | build Wave 1 API image"
      ansible.builtin.command: >
        {{ podman_bin }} build
        -t {{ leadgen_image }}
        {{ leadgen_repo_dir }}/app/api/leadgen_api
      register: build_result
      changed_when: "'Successfully tagged' in (build_result.stdout + build_result.stderr)"

    - name: "systemd | install motorcade-leadgen-api.service"
      ansible.builtin.copy:
        dest: "{{ service_unit_path }}"
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=Motorcade LeadGen API (Wave 1)
          Wants=network-online.target
          After=network-online.target motorcade-postgres.service motorcade-redis.service

          [Service]
          Type=simple
          Environment=PODMAN_BIN={{ podman_bin }}
          ExecStartPre={{ podman_bin }} rm -f {{ leadgen_container_name }}
          ExecStart={{ podman_bin }} run --rm --name {{ leadgen_container_name }}             --network motorcade-core             --env-file {{ leadgen_env_path }}             -p {{ host_bind }}:{{ container_port }}             {{ leadgen_image }}
          ExecStop={{ podman_bin }} stop -t 10 {{ leadgen_container_name }}
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target

    - name: "systemd | daemon-reload"
      ansible.builtin.systemd:
        daemon_reload: true

    - name: "systemd | enable + restart leadgen api"
      ansible.builtin.systemd:
        name: motorcade-leadgen-api.service
        enabled: true
        state: restarted

    - name: "Health | wait for /lead/health"
      ansible.builtin.uri:
        url: "{{ health_url }}"
        method: GET
        return_content: true
        status_code: 200
      register: health
      retries: 30
      delay: 2
      until: health.status == 200

    - name: "Report | health summary"
      ansible.builtin.debug:
        health_json: "{{ health.json | default({}) }}"
