---
# LEADGEN_01 — LeadGen Wave 1 DB schema (bootstrap-safe)
# Creates schema: app
# Creates table: app.leads
# Records: app.schema_migrations.version = 20260126_01_wave1_leads
#
# Run:
#   ansible-playbook -i inventories/prod/hosts.ini playbooks/LEADGEN_01_wave1_db_schema.yml --ask-vault-pass

- name: "LEADGEN_01 — LeadGen Wave 1 DB schema"
  hosts: motorcade
  become: true
  vars:
    podman_bin: "/usr/local/bin/podman"
    pg_container_name: "motorcade-postgres"
    backup_root: "/var/backups/motorcade/postgres/schema"
    migration_sql_src: "files/leadgen/20260126_01_wave1_leads.sql"
    migration_sql_host: "/tmp/20260126_01_wave1_leads.sql"
    migration_version: "20260126_01_wave1_leads"

  tasks:
    - name: "Preflight | podman present"
      ansible.builtin.stat:
        path: "{{ podman_bin }}"
      register: podman_stat
      failed_when: not podman_stat.stat.exists

    - name: "Ensure Postgres service is running (boot-disabled preserved)"
      ansible.builtin.systemd:
        name: motorcade-postgres.service
        state: started

    - name: "Ensure backup directory exists"
      ansible.builtin.file:
        path: "{{ backup_root }}"
        state: directory
        owner: root
        group: root
        mode: "0750"

    - name: "Check if app schema exists (bootstrap-safe)"
      ansible.builtin.shell: |
        set -euo pipefail
        {{ podman_bin }} exec {{ pg_container_name }} psql -U postgres -v ON_ERROR_STOP=1 -tAc           "SELECT 1 FROM pg_namespace WHERE nspname='app';"
      args:
        executable: /bin/bash
      register: app_schema_exists
      changed_when: false

    - name: "Backup app schema (schema-only) before applying migration (only if schema exists)"
      ansible.builtin.shell: |
        set -euo pipefail
        ts="$(date -u +%Y%m%dT%H%M%SZ)"
        out="{{ backup_root }}/app_schema_only.${ts}.sql"
        {{ podman_bin }} exec {{ pg_container_name }} pg_dump -U postgres -n app --schema-only > "${out}"
        echo "${out}"
      args:
        executable: /bin/bash
      register: backup_path
      when: app_schema_exists.stdout.strip() == "1"

    - name: "Print schema backup path (or bootstrap notice)"
      ansible.builtin.debug:
        msg: >-
          {% if app_schema_exists.stdout.strip() == "1" %}
          Schema-only backup created: {{ backup_path.stdout }}
          {% else %}
          Bootstrap-safe: schema 'app' did not exist yet; no backup created.
          {% endif %}

    - name: "Copy migration SQL to target (host)"
      ansible.builtin.copy:
        src: "{{ migration_sql_src }}"
        dest: "{{ migration_sql_host }}"
        owner: root
        group: root
        mode: "0644"

    - name: "Ensure app schema exists (required before migration references app.*)"
      ansible.builtin.shell: |
        set -euo pipefail
        {{ podman_bin }} exec {{ pg_container_name }} psql -U postgres -v ON_ERROR_STOP=1 -c "CREATE SCHEMA IF NOT EXISTS app;"
      args:
        executable: /bin/bash
      changed_when: false

    - name: "Apply migration inside Postgres container (pipe host file into container psql)"
      ansible.builtin.shell: |
        set -euo pipefail
        {{ podman_bin }} exec -i {{ pg_container_name }} psql -U postgres -v ON_ERROR_STOP=1 < "{{ migration_sql_host }}"
      args:
        executable: /bin/bash

    - name: "Verify leads table exists"
      ansible.builtin.shell: |
        set -euo pipefail
        {{ podman_bin }} exec {{ pg_container_name }} psql -U postgres -v ON_ERROR_STOP=1 -tAc           "SELECT to_regclass('app.leads') IS NOT NULL;"
      args:
        executable: /bin/bash
      register: leads_exists
      changed_when: false
      failed_when: leads_exists.stdout.strip() != "t"

    - name: "Verify migration ledger contains version"
      ansible.builtin.shell: |
        set -euo pipefail
        {{ podman_bin }} exec {{ pg_container_name }} psql -U postgres -v ON_ERROR_STOP=1 -tAc           "SELECT version, applied_at FROM app.schema_migrations WHERE version='{{ migration_version }}';"
      args:
        executable: /bin/bash
      register: ledger_row
      changed_when: false
      failed_when: ledger_row.stdout.strip() == ""

    - name: "Show verification output"
      ansible.builtin.debug:
        msg:
          - "leads table present: {{ leads_exists.stdout.strip() }}"
          - "ledger: {{ ledger_row.stdout.strip() }}"
