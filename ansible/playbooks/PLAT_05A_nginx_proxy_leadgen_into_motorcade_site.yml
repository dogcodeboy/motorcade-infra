# ⛔ PROHIBITED — DO NOT RUN
# Reason: nginx is frozen (see docs/RUNBOOK.md). Reverse-proxy/routing changes are deferred.
# Provenance: docs/checkpoints/2026-01-23-5/

---
- name: PLAT_05A | Expose LeadGen API via main Motorcade Nginx vhost
  hosts: all
  become: true

  vars:
    motorcade_vhost_conf: /etc/nginx/conf.d/motorcade.conf
    backup_dir: /etc/nginx/backup
    leadgen_upstream_host: "127.0.0.1"
    leadgen_upstream_port: "8000"

  tasks:
    - name: Verify main vhost exists
      ansible.builtin.stat:
        path: "{{ motorcade_vhost_conf }}"
      register: vhost_stat

    - name: Fail if main vhost missing (this playbook patches motorcade.conf)
      ansible.builtin.fail:
        msg: "Expected {{ motorcade_vhost_conf }} to exist. Run the WordPress nginx playbook first."
      when: not vhost_stat.stat.exists

    - name: Check SELinux status
      ansible.builtin.command: getenforce
      register: selinux_status
      changed_when: false

    - name: Allow nginx to proxy to upstream (SELinux boolean)
      ansible.builtin.command: setsebool -P httpd_can_network_connect on
      when: selinux_status.stdout != "Disabled"

    - name: Ensure nginx backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "0755"

    - name: Backup current motorcade.conf (timestamped)
      ansible.builtin.copy:
        src: "{{ motorcade_vhost_conf }}"
        dest: "{{ backup_dir }}/motorcade.conf.{{ ansible_date_time.iso8601_basic_short }}.bak"
        remote_src: true
        mode: "0644"

    - name: Verify motorcade.vip server_name exists in main vhost
      ansible.builtin.command: >-
        grep -E '^[[:space:]]*server_name[[:space:]].*motorcade\\.vip' {{ motorcade_vhost_conf }}
      register: server_name_grep
      changed_when: false
      failed_when: server_name_grep.rc != 0

    - name: Insert LeadGen reverse proxy locations into motorcade.conf (inside server block)
      ansible.builtin.blockinfile:
        path: "{{ motorcade_vhost_conf }}"
        marker: "# {mark} PLAT_05A_LEADGEN_PROXY"
        insertafter: '^[[:space:]]*server_name[[:space:]].*motorcade\\.vip'
        block: |
          # LeadGen Intake API (PLAT_04) — proxied behind the main site
          # NOTE: This block MUST live inside the relevant `server { ... }`.
          location = /api/lead/health {
              proxy_pass http://{{ leadgen_upstream_host }}:{{ leadgen_upstream_port }}/lead/health;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          location ^~ /api/lead/ {
              proxy_pass http://{{ leadgen_upstream_host }}:{{ leadgen_upstream_port }}/;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_connect_timeout 5s;
              proxy_send_timeout 30s;
              proxy_read_timeout 30s;
          }

    - name: Validate nginx configuration
      ansible.builtin.command: nginx -t
      changed_when: false

    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded

    - name: Post-check (nginx-proxied health)
      ansible.builtin.uri:
        url: "http://127.0.0.1/api/lead/health"
        return_content: true
        status_code: 200
      register: leadgen_health
      changed_when: false

    - name: Print LeadGen health response
      ansible.builtin.debug:
        var: leadgen_health.content
