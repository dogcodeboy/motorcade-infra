---
# LEADGEN_03 — LeadGen Wave 1 write-path hardening
#
# What this does (one-and-done, idempotent):
# 1) Applies DB migration 20260126_02_wave1_write_path (adds intake_id/request_id/idempotency_key)
# 2) Ensures LeadGen env includes LEADGEN_DB_* vars + auth split keys
# 3) Rebuilds the LeadGen API image and restarts motorcade-leadgen-api.service
#
# Expected:
# - Host bind: 127.0.0.1:8000 -> container:8080
# - POST /lead/intake persists a row in app.leads
# - Idempotency-Key is enforced at DB-level (unique index)
#
# Run:
#   cd ~/Repos/motorcade-infra/ansible
#   ansible-playbook -i inventories/prod/hosts.ini playbooks/LEADGEN_03_wave1_write_path_hardening.yml --ask-vault-pass

- name: "LEADGEN_03 — LeadGen Wave 1 write-path hardening"
  hosts: motorcade
  become: true
  gather_facts: true

  # IMPORTANT: this is the correct repo layout (NO ansible/group_vars nesting)
  vars_files:
    - "{{ playbook_dir }}/../group_vars/motorcade/vault.yml"
    - "{{ playbook_dir }}/../group_vars/motorcade/main.yml"

  vars:
    # You can override these in group_vars/motorcade/main.yml if you want.
    motorcade_base_dir: "/opt/motorcade"
    leadgen_app_dir: "{{ motorcade_base_dir }}/leadgen"
    leadgen_data_dir: "{{ leadgen_app_dir }}/data"
    leadgen_logs_dir: "{{ leadgen_app_dir }}/logs"
    leadgen_tmp_dir: "{{ leadgen_app_dir }}/tmp"
    leadgen_config_dir: "{{ leadgen_app_dir }}/config"

    # Ownership: keep root-owned by default; containers can be granted access via group if needed later.
    motorcade_owner: "root"
    motorcade_group: "root"

    # Permissions (tight defaults)
    dir_mode_strict: "0750"
    dir_mode_tmp: "1770"   # sticky bit for tmp, group-writable

    # Podman network expected by the platform
    motorcade_core_network: "motorcade-core"

  pre_tasks:
    - name: "Preflight | ensure running on a supported OS family"
      ansible.builtin.assert:
        that:
          - ansible_facts.os_family in ["RedHat", "Amazon"]
        fail_msg: "Unsupported OS family: {{ ansible_facts.os_family }}"

    - name: "Preflight | podman present"
      ansible.builtin.command: podman --version
      register: podman_version
      changed_when: false

    - name: "Preflight | motorcade-core network exists"
      ansible.builtin.command: "podman network exists {{ motorcade_core_network }}"
      register: net_exists
      changed_when: false
      failed_when: net_exists.rc != 0

    - name: "Preflight | require vault keys (defined + non-empty)"
      ansible.builtin.assert:
        that:
          - vault_leadgen_intake_api_key is defined
          - (vault_leadgen_intake_api_key | string | trim) | length > 0
          - vault_leadgen_admin_api_key is defined
          - (vault_leadgen_admin_api_key | string | trim) | length > 0
          - vault_postgres_password is defined
          - (vault_postgres_password | string | trim) | length > 0
        fail_msg: >-
          Missing required vault values. Expected these in:
          {{ playbook_dir }}/../group_vars/motorcade/vault.yml :
          vault_leadgen_intake_api_key, vault_leadgen_admin_api_key, vault_postgres_password

  tasks:
    - name: "Create base directory structure (strict perms)"
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ motorcade_owner }}"
        group: "{{ motorcade_group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ motorcade_base_dir }}",  mode: "{{ dir_mode_strict }}" }
        - { path: "{{ leadgen_app_dir }}",     mode: "{{ dir_mode_strict }}" }
        - { path: "{{ leadgen_config_dir }}",  mode: "{{ dir_mode_strict }}" }
        - { path: "{{ leadgen_data_dir }}",    mode: "{{ dir_mode_strict }}" }
        - { path: "{{ leadgen_logs_dir }}",    mode: "{{ dir_mode_strict }}" }
        - { path: "{{ leadgen_tmp_dir }}",     mode: "{{ dir_mode_tmp }}" }

    - name: "Harden: remove world-write under motorcade base (except tmp sticky dir)"
      ansible.builtin.command: >
        bash -lc "find '{{ motorcade_base_dir }}' -xdev -type d ! -path '{{ leadgen_tmp_dir }}' -perm -0002 -print -exec chmod o-w {} +"
      changed_when: false

    - name: "Harden: remove world-read under motorcade base (optional safe default)"
      ansible.builtin.command: >
        bash -lc "find '{{ motorcade_base_dir }}' -xdev -type f -perm -0004 -print -exec chmod o-r {} +"
      changed_when: false

    - name: "Place a path manifest (non-secret) for later roles/playbooks"
      ansible.builtin.copy:
        dest: "{{ leadgen_config_dir }}/paths.env"
        owner: "{{ motorcade_owner }}"
        group: "{{ motorcade_group }}"
        mode: "0640"
        content: |
          # Generated by LEADGEN_03_wave1_write_path_hardening.yml
          MOTORCADE_BASE_DIR={{ motorcade_base_dir }}
          LEADGEN_APP_DIR={{ leadgen_app_dir }}
          LEADGEN_CONFIG_DIR={{ leadgen_config_dir }}
          LEADGEN_DATA_DIR={{ leadgen_data_dir }}
          LEADGEN_LOGS_DIR={{ leadgen_logs_dir }}
          LEADGEN_TMP_DIR={{ leadgen_tmp_dir }}

    - name: "Report resulting permissions (for verification)"
      ansible.builtin.command: >
        bash -lc "ls -ld '{{ motorcade_base_dir }}' '{{ leadgen_app_dir }}' '{{ leadgen_config_dir }}' '{{ leadgen_data_dir }}' '{{ leadgen_logs_dir }}' '{{ leadgen_tmp_dir }}'"
      register: perms_report
      changed_when: false

    - name: "Show permission report"
      ansible.builtin.debug:
        var: perms_report.stdout_lines

