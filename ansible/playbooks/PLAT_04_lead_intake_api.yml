# PLAT_04 â€” Lead Intake API (LeadGen)
# Runbook-stable version:
# - Builds on the TARGET HOST from /opt/motorcade-leadgen (no controller-side archive)
# - Uses only ansible.builtin modules (no extra collections)
# - Forces clean rebuild (--no-cache) and restarts container
# - Binds to 127.0.0.1:8000 and waits for /lead/health

- name: "PLAT_04 | Deploy LeadGen Intake API"
  hosts: all
  become: true
  gather_facts: false

  vars:
    leadgen_repo_dir: "/opt/motorcade-leadgen"
    leadgen_container_name: "motorcade-leadgen-api"
    leadgen_image_name: "motorcade-leadgen-api"
    leadgen_bind_ip: "127.0.0.1"
    leadgen_bind_port: "8000"
    leadgen_health_path: "/lead/health"

  tasks:
    - name: "Preflight | Ensure LeadGen build context directory exists"
      ansible.builtin.stat:
        path: "{{ leadgen_repo_dir }}"
      register: leadgen_repo_stat

    - name: "Preflight | Fail if LeadGen build context is missing"
      ansible.builtin.fail:
        msg: >-
          LeadGen build context directory {{ leadgen_repo_dir }} is missing on target host.
          Create it and copy the motorcade-leadgen repo there (must include Containerfile/Dockerfile).
      when: not leadgen_repo_stat.stat.exists or not leadgen_repo_stat.stat.isdir

    - name: "Preflight | Ensure Containerfile or Dockerfile exists in context"
      ansible.builtin.shell: |
        set -e
        test -f "{{ leadgen_repo_dir }}/Containerfile" -o -f "{{ leadgen_repo_dir }}/Dockerfile"
      args:
        executable: /bin/bash

    - name: "Ensure Podman is present"
      ansible.builtin.command: podman --version
      changed_when: false

    - name: "Stop and remove existing LeadGen container if present"
      ansible.builtin.shell: |
        set -e
        if podman ps -a --format '{{'{{'}}.Names{{'}}'}}' | grep -qx "{{ leadgen_container_name }}"; then
          podman rm -f "{{ leadgen_container_name }}"
        fi
      args:
        executable: /bin/bash
      changed_when: true

    - name: "Remove existing LeadGen image if present"
      ansible.builtin.shell: |
        set -e
        if podman images --format '{{'{{'}}.Repository{{'}}'}}:{{'{{'}}.Tag{{'}}'}}' | grep -q "^{{ leadgen_image_name }}:"; then
          podman rmi -f "{{ leadgen_image_name }}"
        fi
      args:
        executable: /bin/bash
      changed_when: true

    - name: "Build LeadGen API image (clean, no cache) from target-host context"
      ansible.builtin.command:
        argv:
          - podman
          - build
          - --no-cache
          - -t
          - "{{ leadgen_image_name }}"
          - "{{ leadgen_repo_dir }}"
      register: build_result
      changed_when: true

    - name: "Run LeadGen API container (loopback-only)"
      ansible.builtin.command:
        argv:
          - podman
          - run
          - -d
          - --name
          - "{{ leadgen_container_name }}"
          - -p
          - "{{ leadgen_bind_ip }}:{{ leadgen_bind_port }}:8000"
          - "{{ leadgen_image_name }}"
      register: run_result
      changed_when: true

    - name: "Wait for LeadGen health endpoint"
      ansible.builtin.uri:
        url: "http://{{ leadgen_bind_ip }}:{{ leadgen_bind_port }}{{ leadgen_health_path }}"
        method: GET
        return_content: false
        status_code: 200
      register: healthcheck
      retries: 30
      delay: 2
      until: healthcheck.status == 200
